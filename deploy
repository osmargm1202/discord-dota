#!/bin/bash

set -e

# Colores para output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Configuraci√≥n
REGISTRY="orgmcr.or-gm.com"
USERNAME="osmargm1202"
IMAGE_NAME="dota-discord-bot"
TAG="latest"
FULL_IMAGE="${REGISTRY}/${USERNAME}/${IMAGE_NAME}:${TAG}"
SERVER="server"

echo -e "${GREEN}üöÄ Iniciando deployment de ${IMAGE_NAME}...${NC}"

# 1. Construir la imagen
echo -e "${YELLOW}üì¶ Construyendo imagen Docker...${NC}"
docker build -t ${FULL_IMAGE} .

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå Error construyendo la imagen${NC}"
    exit 1
fi

# 2. Hacer push al registry
echo -e "${YELLOW}üì§ Subiendo imagen al registry...${NC}"
docker push ${FULL_IMAGE}

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå Error subiendo la imagen al registry${NC}"
    exit 1
fi

# 3. Conectar al servidor y desplegar
echo -e "${YELLOW}üñ•Ô∏è  Desplegando en servidor ${SERVER}...${NC}"
ssh ${SERVER} << EOF
    # Hacer pull de la imagen
    docker pull ${FULL_IMAGE}
    
    # Detener y eliminar contenedor existente si existe
    docker stop ${IMAGE_NAME} 2>/dev/null || true
    docker rm ${IMAGE_NAME} 2>/dev/null || true
    
    # Ejecutar nuevo contenedor
    docker run -d \
        --name ${IMAGE_NAME} \
        --restart unless-stopped \
        --env-file /path/to/.env \
        -e REFRESH_RATE=\${REFRESH_RATE:-1} \
        -e DEBUG=\${DEBUG:-false} \
        -v /path/to/data:/app/data \
        -v /path/to/logs:/app/logs \
        -p 8080:8080 \
        ${FULL_IMAGE}
    
    echo "‚úÖ Contenedor desplegado exitosamente"
EOF

if [ $? -ne 0 ]; then
    echo -e "${RED}‚ùå Error desplegando en el servidor${NC}"
    exit 1
fi

echo -e "${GREEN}‚úÖ Deployment completado exitosamente!${NC}"

